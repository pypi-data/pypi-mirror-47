---

- name: Deploy required packages to bootstrap TripleO
  package:
    name: "{{ packages_bootstrap }}"
  become: true
  ignore_errors: true

- name: Check required packages are installed
  command:
    rpm -q {{ item }}
  with_items: "{{ packages_bootstrap }}"


- name: Create /var/lib/heat-config/tripleo-config-download directory for deployment data
  file:
    path: /var/lib/heat-config/tripleo-config-download
    state: directory
  become: true

# We are using 'network' service provided by 'network-scripts' which is
# deprecated in RHEL8/CentOS8/Fedora28 but os-net-config doesn't support yet
# NetworkManager. Until it happens, we need to ensure that network is started
# at boot, as it'll take care of restarting the network interfaces managed by
# OVS. Note that OVS unit service is already configure to start before
# network.service.
# Note that we don't try to start the service since this is a one shot script
# which can fail if someone tries to starts it a second time.
# See https://bugzilla.redhat.com/show_bug.cgi?id=1701866 for context.
- name: Deploy and enable network service
  when: ansible_distribution_major_version == '8'
  block:
    - name: Deploy network-scripts required for deprecated network service
      package:
        name: network-scripts
      become: true
      ignore_errors: true
    - name: Ensure network service is enabled
      service:
        name: network
        enabled: yes
      become: true

- name: Find all installed puppet modules under /usr/share/openstack-puppet/modules
  find:
    paths:
      - /usr/share/openstack-puppet/modules
    file_type: directory
  register: find_openstack_puppet_modules

- name: Symlink puppet modules under /etc/puppet/modules
  file:
    state: link
    src: "{{ item.path }}"
    path: "/etc/puppet/modules/{{ item.path | basename }}"
  loop: "{{ find_openstack_puppet_modules.files }}"
  loop_control:
    label: "/etc/puppet/modules/{{ item.path | basename }} -> {{ item.path }}"

- name: Create empty ruleset in /etc/sysconfig/iptables and /etc/sysconfig/ip6tables
  copy:
    dest: "{{ item }}"
    content: "# empty ruleset created by deployed-server bootstrap"
  loop:
    - /etc/sysconfig/iptables
    - /etc/sysconfig/ip6tables

- name: Check if /usr/bin/ansible-playbook exists
  stat:
    path: /usr/bin/ansible-playbook
  register: stat_ansible_playbook

- name: Check if /usr/bin/ansible-playbook-3 exists
  stat:
    path: /usr/bin/ansible-playbook-3
  register: stat_ansible_playbook_3

- name: Symlink /usr/local/bin/ansible-playbook to /usr/bin/ansible-playbook-3
  file:
    state: link
    src: /usr/bin/ansible-playbook-3
    path: /usr/local/bin/ansible-playbook
  when:
    - not stat_ansible_playbook.stat.exists
    - stat_ansible_playbook_3.stat.exists

- name: Symlink /usr/local/bin/ansible-playbook-3 to /usr/bin/ansible-playbook
  file:
    state: link
    src: /usr/bin/ansible-playbook
    path: /usr/local/bin/ansible-playbook-3
  when:
    - stat_ansible_playbook.stat.exists
    - not stat_ansible_playbook_3.stat.exists
