heat_template_version: newton

description: |
  Stack of resources used to test floating IP


parameters:
  key_name:
    type: string

  flavor:
    type: string

  image:
    type: string

  floating_network:
    type: string

  internal_network:
    type: string

  port_security_enabled:
    type: boolean
    default: false

  security_groups:
    type: comma_delimited_list
    default: []


resources:

  port:
    type: OS::Neutron::Port
    properties:
      network: {get_param: internal_network}
      port_security_enabled: {get_param: port_security_enabled}
      security_groups: {get_param: security_groups}

  server_name:
    type: OS::Heat::RandomString
    properties:
      character_classes: [{'class': 'lowercase', 'min': 1}]
      length: 8

  server:
    type: OS::Nova::Server
    properties:
      name: {get_attr: [server_name, value]}
      key_name: {get_param: key_name}
      image: {get_param: image}
      flavor: {get_param: flavor}
      networks:
        - port: {get_resource: port}

  floating_ip:
    type: OS::Neutron::FloatingIP
    properties:
      floating_network: {get_param: floating_network}

  floating_ip_association:
    type: OS::Neutron::FloatingIPAssociation
    properties:
      floatingip_id: {get_resource: floating_ip}
      port_id: {get_resource: port}


outputs:

  floating_ip_address:
    value: {get_attr: [floating_ip, floating_ip_address]}

  port_security_enabled:
    value: {get_attr: [port, port_security_enabled]}

  security_groups:
    value: {get_attr: [port, security_groups]}

  server_name:
    value: {get_attr: [server, name]}
