---
jupyter:
  jupytext:
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.1'
      jupytext_version: 1.1.1
  kernelspec:
    display_name: Python 3
    language: python
    name: python3
---

```{python nbsphinx=hidden}
import matplotlib.cbook

import warnings
import plotnine
warnings.filterwarnings(module='plotnine*', action='ignore')
warnings.filterwarnings(module='matplotlib*', action='ignore')

# %matplotlib inline
```

# Using to query SQL


# Setting up

```{python}
import pandas as pd
from siuba.tests.helpers import copy_to_sql
from siuba import *
from siuba.dply.vector import lag, desc, row_number
from siuba.dply.string import str_c

tv_ratings = pd.read_csv(
    "https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2019/2019-01-08/IMDb_Economist_tv_ratings.csv",
    parse_dates = ["date"]
    )

```

```{python}
tbl_ratings = copy_to_sql(tv_ratings, "tv_ratings", "postgresql://postgres:@localhost:5433/postgres")

```

```{python}
tbl_ratings

```

## Inspecting a single show

```{python}
buffy = (tbl_ratings
  >> filter(_.title == "Buffy the Vampire Slayer")
  >> collect()
  )

buffy
```

```{python}
buffy >> summarize(avg_rating = _.av_rating.mean())
```

## Average rating per show, along with dates

```{python}
avg_ratings = (tbl_ratings 
  >> group_by(_.title)
  >> summarize(
       avg_rating = _.av_rating.mean(),
       date_range = str_c(_.date.dt.year.max(), " - ", _.date.dt.year.min())
       )
  )

avg_ratings
```

## Biggest changes in ratings between two seasons

```{python}
top_4_shifts = (tbl_ratings
  >> group_by(_.title)
  >> mutate(rating_shift = _.av_rating - lag(_.av_rating))
  >> summarize(
       max_shift = _.rating_shift.max()
     )
  >> arrange(-_.max_shift)
  >> head(4)
  )

top_4_shifts
```

```{python}
big_shift_series = (top_4_shifts
  >> select(_.title)
  >> inner_join(_, tbl_ratings, "title")
  >> collect()
  )

from plotnine import *

(big_shift_series
  >> ggplot(aes("seasonNumber", "av_rating"))
   + geom_point()
   + geom_line()
   + facet_wrap("~ title")
   + labs(
       title = "Seasons with Biggest Shifts in Ratings",
       y = "Average rating",
       x = "Season"
     )
  )
```

## Do we have full data for each season?

```{python}
mismatches = (tbl_ratings
  >> arrange(_.title, _.seasonNumber)
  >> group_by(_.title)
  >> mutate(
       row = row_number(_),
       mismatch = _.row != _.seasonNumber
     )
  >> filter(_.mismatch.any())
  >> ungroup()
  )


mismatches
```

```{python}
mismatches >> distinct(_.title) >> count() >> collect()
```
