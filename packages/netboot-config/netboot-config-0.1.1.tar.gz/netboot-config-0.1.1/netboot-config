#!/usr/bin/env python3
import os

import yaml

from netboot_config.model import HostConfig, ConfigFile
from netboot_config.network import HostGroup

with open("test/test_data.yml", 'r') as stream:
    data_loaded = yaml.safe_load(stream)

    for data in data_loaded['hostgroups']:
        host_group = HostGroup(data['prefix'], data['cidr'])
        for image in data['images']:
            host_group.add_hosts(image['image_type'], image['offset'], image['count'])

        hosts = host_group.hosts()
        for host in hosts:
            host_config = HostConfig()
            path = host.host_name()

            os.makedirs(path, exist_ok=True)
            host_name_file_path = os.path.join(path, 'hostname')
            with open(host_name_file_path, 'w') as host_name_file:
                host_name_file.write("{}\n".format(host.host_name()))
            host_name = host.host_name()
            host_config.add(host_name_file_path, '/etc/hostname')

            ConfigFile(host, host_config).write()

